<!DOCTYPE html>
<!--
Created using JS Bin
http://jsbin.com

Copyright (c) 2022 by ricardogang (http://jsbin.com/tiyujuv/1/edit)

Released under the MIT license: http://jsbin.mit-license.org
-->

<!--
Sofia Campos - B91750
Emmanuel Zúñiga - B98729    
-->

<meta name="robots" content="noindex">
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>JS Bin</title>
</head>
<body>

	<H3>UNIVERSIDAD DE COSTA RICA</H3>
<H4>GENETIC ALGORITHMS SCAFFOLDING</H4>
LOADS AN IMAGE FROM LOREMPIXEL, CREATES RANDOM IMAGES AND ESTIMATES SIMILARITY (THE LOWER THE NUMBER THE MORE SIMILAR, ASSUMING SIMILARITY AS A PIXEL PER PIXEL COLOR COMPARISON).<BR>

<canvas id="canvas" width="100" height="100"></canvas> 
<table id="table"></table>
<style>canvas {padding: 3px ;}</style>
<script>

function Figura (tipo, x1, y1, x2, y2, fill, stroke) {
    this.tipo = tipo;
    this.x1  = x1;
    this.y1  = y1;
    this.x2  = x2;
    this.y2  = y2;
    this.fill = fill;
    this.stroke = stroke;

    this.toString= function() {
      return "FIGURA: Tipo: "+this.tipo+" [x:"+this.x+" , y:"+this.y+"]";
    }

}

var img = new Image;
var src = "image.png";
var cvs = document.getElementById('canvas');
var ctx = cvs.getContext('2d');
img.crossOrigin = "Anonymous";
var population = [];
var bestPopulation = [];
var worstPopulation = [];
canvas= [];
context= [];
var imgData ;
var nImages= 20 ;
var imageData= [] ;


img.onload = function() {
    //crossover(population[0], population[1]);
    ctx.drawImage( img, 0, 0 );
    imgData= ctx.getImageData(0,0,100,100) ;
    table= document.getElementById('table') ;
    generarPoblacionInicial();
    for(var generation = 0; generation < 1; generation++){
        for (var i=0; i<nImages;i++){
            canvas[i]= document.createElement("canvas");
            canvas[i].width= canvas[i].height= "100";
            context[i]= canvas[i].getContext('2d');
            getImage(context[i], population[i]);
            //context[i].putImageData(imgData,0,0) ;
            imageData[i]= context[i].getImageData(0,0,100,100);
            context[i].font = 'italic 10pt Calibri';
            var similarityImages = similarity(imgData, imageData[i]);
            population[i][population[i].length] = similarityImages;
            context[i].fillText(similarityImages,10,95);
        }

        selection();

        for(var i = 0; i < nImages; i++){
            if (i%5==0) {
                row= table.insertRow(table.rows.length) ;
            }
            canvas[i]= document.createElement("canvas") ;
            canvas[i].width= canvas[i].height= "100" ;
            context[i]= canvas[i].getContext('2d') ;
            getImage(context[i], population[i]) ;
            //context[i].putImageData(imgData,0,0) ;
            imageData[i] = context[i].getImageData(0,0,100,100) ;
            context[i].font = 'italic 10pt Calibri';
            var similarityImages = similarity(imgData, imageData[i]);
            context[i].fillText(similarityImages,10,95);
            row.appendChild(canvas[i]) ;
        }
    }
}

img.src = src;

function getImage(context, imagen) {

    for(var c = 0; c < imagen.length; c++){
        if(imagen[c].tipo == "Circulo"){
            drawCircle(context,imagen[c].x1,imagen[c].y1, imagen[c].x2, imagen[c].fill,3,imagen[c].stroke) ;
        } else if(imagen[c].tipo == "Linea"){
            drawLine(context,imagen[c].x1,imagen[c].y1,imagen[c].x2,imagen[c].y2,imagen[c].fill,imagen[c].stroke);
        } else{
            lineWidth= Math.floor((Math.random() * 5) + 1);
            drawRectangle(context, imagen[c].x1,imagen[c].y1,imagen[c].x2,imagen[c].y2,imagen[c].fill, lineWidth, imagen[c].stroke) ;
        }
    }
}

function drawRectangle(context,x1,y1,x2,y2,fill,lineWidth,stroke) {
	  context.beginPath();
      context.rect(x1, y1, x2, y2);
      context.fillStyle = fill ;
      context.fill();
      context.lineWidth = lineWidth;
      context.strokeStyle = stroke;
      context.stroke();
}

function drawLine(context,x1,y1,x2,y2,lineWidth,stroke) {
	  context.beginPath();
      context.moveTo(x1, y1);
      context.lineTo(x2, y2);
      context.lineWidth= lineWidth ;
      context.strokeStyle= stroke ;
      context.stroke();
}

function drawCircle(context, x,y,radius,fill,lineWidth,stroke) {
	  context.beginPath();
      context.arc(x, y, radius, 0, 2 * Math.PI, false);
      context.fillStyle = fill;
      context.fill();
      context.lineWidth = lineWidth;
      context.strokeStyle = stroke;
      context.stroke();
}


function similarity(imageData1, imageData2) {
	data1= imageData1.data ;
    data2= imageData2.data ;
    suma=0 ;
    for (var i=0;i<data1.length;i+=4) {
    	suma+= Math.pow((data1[i]-data2[i]),2);
        suma+= Math.pow((data1[i+1]-data2[i+1]),2);
        suma+= Math.pow((data1[i+2]-data2[i+2]),2);
    }
    return Math.pow(suma,1/2) ;
}

function generarPoblacionInicial(){
    for(var f=0; f<nImages;f++){
        nCircles= Math.floor((Math.random() * 3) + 1);
        nLines= Math.floor((Math.random() * 3) + 1);
        nRectangles= Math.floor((Math.random() * 3) + 1);
        var figuras = new Array();
        counter = 0;
        for (var i=0 ; i<nCircles;i++) {
            x1= Math.floor((Math.random() * 100) + 1);
            y1= Math.floor((Math.random() * 100) + 1);
            fill= "#"+Math.floor((Math.random() * 100) + 1)+Math.floor((Math.random() * 100) + 1)+Math.floor((Math.random() * 100) + 1);
            stroke= "#"+Math.floor((Math.random() * 100) + 1)+Math.floor((Math.random() * 100) + 1)+Math.floor((Math.random() * 100) + 1);
            radius= Math.floor((Math.random() * 20) + 1);
            lineWidth= Math.floor((Math.random() * 5) + 1);
            figuras[counter] = new Figura("Circulo", x1, y1, radius, 0, fill, stroke);
            counter++;
        }
        
        for (var i=0 ; i<nLines;i++) {
            x1= Math.floor((Math.random() * 100) + 1);
            x2= Math.floor((Math.random() * 100) + 1);
            y1= Math.floor((Math.random() * 100) + 1);
            y2= Math.floor((Math.random() * 100) + 1);
            stroke= "#"+Math.floor((Math.random() * 100) + 1)+Math.floor((Math.random() * 100) + 1)+Math.floor((Math.random() * 100) + 1);
            lineWidth= Math.floor((Math.random() * 5) + 1);
            figuras[counter] = new Figura("Linea", x1, y1, x2, y2, lineWidth, stroke);
            counter++;
        }
        
        for (var i=0 ; i<nRectangles;i++) {
            x1= Math.floor((Math.random() * 100) + 1);
            x2= Math.floor((Math.random() * 100) + 1);
            y1= Math.floor((Math.random() * 100) + 1);
            y2= Math.floor((Math.random() * 100) + 1);
            fill= "#"+Math.floor((Math.random() * 100) + 1)+Math.floor((Math.random() * 100) + 1)+Math.floor((Math.random() * 100) + 1);
            stroke= "#"+Math.floor((Math.random() * 100) + 1)+Math.floor((Math.random() * 100) + 1)+Math.floor((Math.random() * 100) + 1);
            lineWidth= Math.floor((Math.random() * 5) + 1);
            figuras[counter] = new Figura("Rectangulo", x1, y1, x2, y2, fill, stroke);
            counter++;
        }

        population[f] = figuras;
    }
}

function crossover(image1, image2){
    len1 = image1.length;
    len2 = image2.length;
    max = get_max(len1, len2);
    console.log(max);
    var imageArray = new Array();

    for (var i = 0; i < max; i += 2){
        var figure1 = image1[Math.floor(Math.random() * len1)];
        var figure2 = image2[Math.floor(Math.random() * len2)];

        imageArray.push(new Figura(figure1.tipo, figure1.x1, figure1.y1, figure1.x2, figure1.y2, figure1.fill, figure1.stroke));
    
        imageArray.push( new Figura(figure2.tipo, figure2.x1, figure2.y1, figure2.x2, figure2.y2, figure2.fill, figure2.stroke));
    } 
    console.log(imageArray);
    population.push(imageArray);
}

function sortPopulation(){
    population.sort(function (a, b) {
        if (a[a.length - 1] > b[b.length - 1]) {
            return 1;
        }
        if (a[a.length - 1] < b[b.length - 1]) {
            return -1;
        }
        return 0;
    });
}

function get_max(n1, n2){
    if (n1 >= n2){
        return n1;
    } else {
        return n2;
    }
}

function selection(){
    sortPopulation();
    console.log(population);
    var best = (nImages*90/100).toFixed();
    var worst = (nImages*10/100).toFixed();
    var count = 0;
    for(var i = 0; i < nImages; i++){
        if(i < best){
            bestPopulation[i] = population[i];
        }else{
            worstPopulation[count] = population[i];
            count++;
        }
    }
    console.log(bestPopulation);
    console.log(worstPopulation);
}

/**
 * Mutate the genes of an individual, arbitrarily changing an element of the individual.
 **/
 function mutate(image){
    len = image.length;
    //gene to be changed from the individual
    randomGen = Math.floor(Math.random() * len);
    //Change the selected gen of the individual
    image[randomGen] = getRandomFigure(Math.floor(Math.random() * 3));

    return image;
}
/**
 * Generates a random figure;
 **/
function getRandomFigure(value){
    var newFigure;
    //Figure parameters
    rx1 = Math.floor((Math.random() * 100) + 1);
    rx2 = Math.floor((Math.random() * 100) + 1);
    ry1 = Math.floor((Math.random() * 100) + 1);
    ry2 = Math.floor((Math.random() * 100) + 1);
    rfill = "#"+Math.floor((Math.random() * 100) + 1)+Math.floor((Math.random() * 100) + 1)+Math.floor((Math.random() * 100) + 1);
    rstroke = "#"+Math.floor((Math.random() * 100) + 1)+Math.floor((Math.random() * 100) + 1)+Math.floor((Math.random() * 100) + 1);

    switch(value){
        case 0:
            //Creates a new line
            newFigure = new Figura("Linea", rx1, ry1, rx2, ry2, rfill, rstroke);
            break;
        case 1:
            //Creates a new rectangle
            newFigure = new Figura("Rectangulo", rx1, ry1, rx2, ry2, rfill, rstroke);
            break;
        case 2:
            //Creates a new circle
            rradius = Math.floor((Math.random() * 20) + 1);
            newFigure = new Figura("Circulo", rx1, ry1, rradius, 0, rfill, rstroke);
            break;        
    }

    return newFigure;
}
</script>


	
</body>
</html>